---
title: "pca-with-data"
author: "Michelle Li"
date: "6/27/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rgl)
```

----

## Handwritten PCA -------------------------------------

## Paul Data
```{r prepare-paul, echo=FALSE}
## load data 
load("/Users/Michelle/Downloads/data_Paul_Cell2015/Paul_Cell_MARSseq_GSE72857.RData")
dataname <- "Paul Data" # enter title of data
## MAKE SURE you have #rows>#columns
X <- data

## create factor for grouping
groupsf <- factor(cluster.id) # paul data
nclusters <- nlevels(groupsf) # number of groups to cluster
colors <- rainbow(nclusters) # choose colors
```

```{r center-paul, echo=FALSE}
## center data
M1centered <- scale(X, center=TRUE, scale=FALSE) # subtracts column means from each column
C <- cov(M1centered) # gives you Gram matrix (smaller dim than normal covariance matrix)
```

Choose eig or svd:

Eig
U (eig vectors of original covariance matrix) = M1centered * V (eig vectors of fake covariance matrix (Gram Matrix))
U from eig is a scale of the U from svd
unclear on the exact relationship between U from eig and U from svd
```{r eig-paul, echo=FALSE}
technique <- "eig"
eig <- eigen(C) 
V <- eig$vectors # V=columns are the eig vectors of Gram matrix
V <- -V # by default, eig vectors in R point in the negative direction. Multiply by -1 to use the positive-pointing vector
U1 <- M1centered %*% V # U: columns are the eig vectors of original covariance matrix
U <- scale(U1, center=FALSE, scale=TRUE) # normalize U

# eig: U (eig vectors of original covariance matrix) = M1centered * V (eig vectors of fake covariance matrix (Gram Matrix))
# U from eig is a scale of the U from svd
# unclear on the exact relationship between U from eig and U from svd
```

SVD
```{r svd-paul, echo=FALSE}
technique <- "svd"
svd <- svd(M1centered)
U <- svd$u
```

Calculate PC scores
```{r pc scores-paul, echo=FALSE}
scores <- t(U) %*% M1centered # rows of scores are the principal components
```

Plotting:
2D plot
```{r plot2d-paul, echo=FALSE}
plot(x=scores[1,], y=scores[2,], xlab="PC1", ylab="PC2", col = colors[groupsf], pch=20, main = paste("PCA (Handwritten), ", dataname, ", ", technique))
legend("bottomright", inset = c(0,0), legend = levels(groupsf), pch = 20, col = colors, ncol=3, cex=0.4)
```
3D plot
```{r plot3d-paul, echo=FALSE}
plot3d(x=scores[1,], y=scores[2,], z=scores[3,], xlab="PC1", ylab="PC2", zlab="PC3", col = colors[groupsf], pch=20, main = paste("PCA (Handwritten), ", dataname, ", ", technique))
```

Add legend to 3d plot AFTER making the plot larger
```{r legend3d-paul, echo=FALSE}
legend3d("bottomright", legend = levels(groupsf), inset=c(0.2,0.2), pch = 20, col = colors, ncol=3, cex=1)
```

## Nestorowa Data

Prepare data, create factor for grouping
```{r prepare-nestorowa, echo=FALSE}
coordinates_gene_counts_flow_cytometry <- read.delim("~/Downloads/coordinates_gene_counts_flow_cytometry.txt", row.names=1)
rawdata <- coordinates_gene_counts_flow_cytometry
cleandata <- na.omit(rawdata) # remove rows with NA
data <- cleandata[,14:ncol(cleandata)] # choose relevant flow cytometry data
dataname <- "Nestorowa Data"

# create factor for grouping
rownames <- row.names(data)
groups <- as.character(rownames)
groups[grepl("HSPC",groups)] <- "HSPC" # replace all labels with hspc
groups[grepl("LT",groups)] <- "LT.HSC" # replace with lt.hsc
groups[grepl("Prog",groups)] <- "PROG" # same for prog
groupsf <- factor(groups)
nclusters <- nlevels(groupsf) # number of groups to cluster
colors <- rainbow(nclusters) # choose colors
```

Center data
```{r center-nestorowa, echo=FALSE}
## center data
M1centered <- scale(X, center=TRUE, scale=FALSE) # subtracts column means from each column
C <- cov(M1centered) # gives you Gram matrix (smaller dim than normal covariance matrix)
```

Choose eig or svd:

Eig
```{r eig-nestorowa, echo=FALSE}
technique <- "eig"
eig <- eigen(C) 
V <- eig$vectors # V=columns are the eig vectors of Gram matrix
V <- -V # by default, eig vectors in R point in the negative direction. Multiply by -1 to use the positive-pointing vector
U1 <- M1centered %*% V # U: columns are the eig vectors of original covariance matrix
U <- scale(U1, center=FALSE, scale=TRUE) # normalize U
```

SVD
```{r svd-nestorowa, echo=FALSE}
technique <- "svd"
svd <- svd(M1centered)
U <- svd$u
```

Plotting:
2D plot of scores (weights)
```{r plot2dscores-nestorowa, echo=FALSE}
plot(x=scores[1,], y=scores[2,], xlab="PC1 scores", ylab="PC2 scores", col = colors[groupsf], pch=20, main = paste("PCA Scores (Handwritten), ", dataname, ", ", technique))
pch=20, main = paste("PCA (Handwritten), ", dataname, ", ", technique))
legend("bottomright", inset = c(0,0), legend = levels(groupsf), pch = 20, col = colors, ncol=3, cex=0.4)
```

3D plot of scores (weights)
```{r plot3dscores-nestorowa, echo=FALSE}
plot3d(x=scores[1,], y=scores[2,], z=scores[3,], xlab="PC1 scores", ylab="PC2 scores", zlab="PC3 scores", col = colors[groupsf], pch=20, main = paste("PCA Scores (Handwritten), ", dataname, ", ", technique))
```

Add legend to 3d plot AFTER making the plot larger
```{r legend3d-nestorowa, echo=FALSE}
legend3d("bottomright", legend = levels(groupsf), inset=c(0.2,0.2), pch = 20, col = colors, ncol=3, cex=1)
```


